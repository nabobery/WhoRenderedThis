name: Submit Dry Run

on:
  workflow_dispatch:
    inputs:
      stores:
        description: 'Which stores to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - firefox
          - edge

jobs:
  dry-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Chrome
        run: pnpm build

      - name: Create Chrome ZIP
        run: pnpm zip

      - name: Build Firefox
        run: pnpm build:firefox

      - name: Create Firefox ZIP
        run: pnpm zip:firefox

      - name: Dry run - Firefox
        if: ${{ inputs.stores == 'all' || inputs.stores == 'firefox' }}
        run: |
          pnpm wxt submit --dry-run \
            --firefox-zip .output/*-firefox.zip \
            --firefox-sources-zip .output/*-sources.zip
        env:
          FIREFOX_EXTENSION_ID: ${{ secrets.FIREFOX_EXTENSION_ID }}
          FIREFOX_JWT_ISSUER: ${{ secrets.FIREFOX_JWT_ISSUER }}
          FIREFOX_JWT_SECRET: ${{ secrets.FIREFOX_JWT_SECRET }}

      - name: Dry run - Edge
        if: ${{ inputs.stores == 'all' || inputs.stores == 'edge' }}
        run: |
          pnpm wxt submit --dry-run \
            --edge-zip .output/*-chrome.zip
        env:
          EDGE_PRODUCT_ID: ${{ secrets.EDGE_PRODUCT_ID }}
          EDGE_CLIENT_ID: ${{ secrets.EDGE_CLIENT_ID }}
          EDGE_API_KEY: ${{ secrets.EDGE_API_KEY }}

      # Chrome dry run (uncomment when Chrome Web Store listing is created)
      # - name: Dry run - Chrome
      #   if: ${{ inputs.stores == 'all' || inputs.stores == 'chrome' }}
      #   run: |
      #     pnpm wxt submit --dry-run \
      #       --chrome-zip .output/*-chrome.zip
      #   env:
      #     CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
      #     CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
      #     CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
      #     CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
